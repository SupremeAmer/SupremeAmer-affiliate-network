<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SupremeAmer Affiliate Network</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f8f8f8; }
    .tab-btn.active { background: linear-gradient(90deg, #4b0082 60%, #7c43bd 100%); color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .modal-bg { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh;background:rgba(32,0,64,0.21);z-index:1200;align-items:center;justify-content:center;}
    .modal-bg.open { display:flex; }
    .modal { background: #fff; border-radius: 18px; padding: 32px 27px; max-width: 95vw; box-shadow: 0 8px 36px #7c43bd28;}
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-indigo-900 to-purple-700 shadow text-white">
    <div>
      <div class="text-2xl font-bold">SupremeAmer</div>
      <div class="text-xs">The Affiliate Network for Smart Earners & Advertisers</div>
    </div>
    <div class="flex flex-col items-end">
      <span id="user-email" class="text-xs opacity-80"></span>
      <span id="user-username" class="text-lg font-semibold"></span>
      <button id="profileBtn" class="text-2xl">&#x263A;</button>
    </div>
    <!-- Profile Modal -->
    <div id="profileModal" class="modal-bg">
      <div class="modal">
        <h3 class="font-bold mb-2 text-indigo-800">Your Profile</h3>
        <div><b>ID:</b> <span id="user-id"></span></div>
        <div><b>Username:</b> <span id="user-username-modal"></span></div>
        <div><b>Email:</b> <span id="user-email-modal"></span></div>
        <div class="mt-3"><b>Your Invitation Link:</b>
          <div class="bg-gray-100 rounded px-3 py-1 mt-1 select-all" id="invitation-url"></div>
        </div>
        <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal">Close</button>
      </div>
    </div>
  </header>

  <!-- Account Balance -->
  <section class="bg-white shadow rounded-2xl mx-auto mt-2 mb-2 p-5 max-w-lg flex flex-col items-center">
    <div class="text-gray-800 font-semibold mb-1">Account Balance</div>
    <div class="text-3xl text-indigo-800 font-bold mb-2" id="account-balance">$SA 0</div>
    <div class="flex gap-4">
      <button class="bg-blue-600 text-white px-5 py-2 rounded" id="fundBtn">Fund</button>
      <button class="bg-green-600 text-white px-5 py-2 rounded" id="cashoutBtn">Cashout</button>
      <button class="bg-orange-600 text-white px-5 py-2 rounded" id="paymentHistoryBtn">Payment History</button>
    </div>
  </section>

  <!-- Tabs Navigation -->
  <nav class="flex justify-center gap-2 mb-4 mt-2">
    <button class="tab-btn px-5 py-2 rounded active" data-tab="homeTab">Home</button>
    <button class="tab-btn px-5 py-2 rounded" data-tab="marketTab">Market</button>
    <button class="tab-btn px-5 py-2 rounded" data-tab="inviteTab">Invite</button>
    <button class="tab-btn px-5 py-2 rounded" data-tab="walletTab">Wallet</button>
    <button class="tab-btn px-5 py-2 rounded" id="helpSupportBtn">Help & Support</button>
  </nav>

  <!-- Tab Contents -->
  <div id="homeTab" class="tab-content active max-w-2xl mx-auto bg-white rounded-xl shadow p-7">
    <h2 class="text-xl font-bold mb-3 text-indigo-900">Dashboard Overview</h2>
    <div id="dashboard-content"></div>
  </div>

  <div id="marketTab" class="tab-content max-w-2xl mx-auto bg-white rounded-xl shadow p-7">
    <h2 class="text-xl font-bold mb-3 text-indigo-900">Marketplace</h2>
    <div id="market-list" class="mb-5"></div>
    <button id="uploadAdvertBtn" class="bg-indigo-600 text-white px-6 py-2 rounded mb-2">Upload Advert</button>
    <!-- Upload Modal -->
    <div id="uploadAdvertModal" class="modal-bg">
      <div class="modal">
        <h3 class="font-bold mb-2 text-indigo-800">Upload Advert</h3>
        <form id="uploadAdvertForm" class="flex flex-col gap-3">
          <input type="text" id="ad-title" class="border rounded px-3 py-2" placeholder="Advert Title" required />
          <select id="ad-category" class="border rounded px-3 py-2" required>
            <option value="">Select Category</option>
            <option value="Social Media">Social Media</option>
            <option value="Referral">Referral</option>
            <option value="Video/Content">Video/Content</option>
            <option value="Crypto">Crypto</option>
            <option value="Others">Others</option>
          </select>
          <input type="number" id="ad-clicks" class="border rounded px-3 py-2" min="50" placeholder="Clicks (min 50)" required />
          <input type="url" id="ad-url" class="border rounded px-3 py-2" placeholder="Advert URL" required />
          <button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded">Submit</button>
        </form>
        <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal">Cancel</button>
      </div>
    </div>
  </div>

  <div id="inviteTab" class="tab-content max-w-2xl mx-auto bg-white rounded-xl shadow p-7">
    <h2 class="text-xl font-bold mb-3 text-indigo-900">Invite Friends</h2>
    <div class="mb-3">Share your unique invitation link to earn rewards!</div>
    <input type="text" readonly class="w-full border rounded px-3 py-2 mb-3 bg-gray-100" id="invite-link" />
    <button class="bg-green-600 text-white px-5 py-2 rounded" id="copyInviteBtn">Copy Invite Link</button>
    <div class="mt-6">
      <h3 class="font-semibold mb-2 text-indigo-800">Your Invited Friends</h3>
      <div id="invitee-list"></div>
    </div>
  </div>

  <div id="walletTab" class="tab-content max-w-2xl mx-auto bg-white rounded-xl shadow p-7">
    <h2 class="text-xl font-bold mb-3 text-indigo-900">Wallet</h2>
    <button id="connectWalletBtn" class="bg-yellow-400 hover:bg-yellow-500 transition text-black px-4 py-2 rounded">Connect Wallet</button>
    <div id="wallet-details" class="hidden mt-3 border border-indigo-200 rounded p-3 bg-indigo-50 text-indigo-900">
      <div><b>Wallet Address:</b> <span id="wallet-address"></span></div>
      <div><b>ETH Balance:</b> <span id="eth-balance"></span></div>
      <div><b>$SA Balance:</b> <span id="sa-balance"></span></div>
    </div>
  </div>

  <!-- Payment History Modal -->
  <div id="paymentHistoryModal" class="modal-bg">
    <div class="modal">
      <h3 class="font-bold mb-2 text-indigo-800">Payment History</h3>
      <div id="payment-history-content"></div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal">Close</button>
    </div>
  </div>
  <!-- Help & Support Modal -->
  <div id="helpSupportModal" class="modal-bg">
    <div class="modal">
      <h3 class="font-bold mb-2 text-indigo-800">Help & Support</h3>
      <div class="mb-2">Email: <a href="mailto:support@supremeamer.com" class="text-blue-600 underline">support@supremeamer.com</a></div>
      <div class="mb-2">AI Quick Response:<br><span class="italic text-gray-700">"How can we help? Describe your issue and our AI will provide a quick answer or escalate to a human!"</span></div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal">Close</button>
    </div>
  </div>

  <script>
    // Appwrite config
    const client = new Appwrite.Client();
    client.setEndpoint('YOUR_APPWRITE_ENDPOINT').setProject('68370442000c3c15b9f3');
    const account = new Appwrite.Account(client);
    const databases = new Appwrite.Databases(client);

    // SupremeAmer Token
    const SUPREMEAMER_TOKEN_ADDRESS = "YOUR_SUPREMEAMER_TOKEN_CONTRACT_ADDRESS";
    const SUPREMEAMER_TOKEN_ABI = [ /* ... Your ERC20 ABI ... */ ];

    // Tab navigation
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        this.classList.add("active");
        document.querySelectorAll(".tab-content").forEach(tc=>tc.classList.remove("active"));
        document.getElementById(this.dataset.tab).classList.add("active");
      };
    });

    // Profile modal
    document.getElementById("profileBtn").onclick = () =>
      document.getElementById("profileModal").classList.add("open");
    document.querySelectorAll(".close-modal").forEach(btn =>
      btn.onclick = () => btn.closest(".modal-bg").classList.remove("open")
    );

    // Help/Support modal
    document.getElementById("helpSupportBtn").onclick = () =>
      document.getElementById("helpSupportModal").classList.add("open");

    // Get user info from Appwrite
    let currentUser = null;
    (async () => {
      try {
        currentUser = await account.get();
        document.getElementById("user-email").textContent = currentUser.email;
        document.getElementById("user-username").textContent =
          currentUser.name || currentUser.email.split('@')[0];
        document.getElementById("user-username-modal").textContent =
          currentUser.name || currentUser.email.split('@')[0];
        document.getElementById("user-email-modal").textContent = currentUser.email;
        document.getElementById("user-id").textContent = currentUser.$id;
        // Invitation Link
        const inviteUrl = window.location.origin + "/register.html?invite=" + currentUser.$id;
        document.getElementById("invitation-url").textContent = inviteUrl;
        document.getElementById("invite-link").value = inviteUrl;

        // Fetch account balance and update UI
        // Example: fetch from transactions collection and sum user's total
        const txs = await databases.listDocuments('683705ff00244f73e93f', '6838d452002b08ad3c9c', [
          Appwrite.Query.equal('userId', currentUser.$id),
        ]);
        let balance = txs.documents.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0);
        document.getElementById("account-balance").textContent = `$SA ${balance}`;

        // Payment history modal
        document.getElementById("paymentHistoryBtn").onclick = async () => {
          const txs = await databases.listDocuments('683705ff00244f73e93f', '6838d452002b08ad3c9c', [
            Appwrite.Query.equal('userId', currentUser.$id)
          ]);
          document.getElementById("payment-history-content").innerHTML =
            "<ul>" + txs.documents.map(
              tx => `<li>${tx.date}: <span class="text-green-700">${tx.type}</span> <b>${tx.amount}</b></li>`
            ).join("") + "</ul>";
          document.getElementById("paymentHistoryModal").classList.add("open");
        };

        // Invitee list
        document.getElementById("inviteTab").onclick = async () => {
          const invited = await databases.listDocuments('683705ff00244f73e93f', '6838d38200133d8c3de0', [
            Appwrite.Query.equal('invitedBy', currentUser.$id)
          ]);
          document.getElementById("invitee-list").innerHTML = invited.documents.length
            ? invited.documents.map(u =>
                `<div class="text-green-700">${u.name || u.email}</div>`
              ).join('')
            : "<div class='text-gray-500'>No invitees yet.</div>";
        };

        // Market list (adverts)
        const renderMarket = async () => {
          const ads = await databases.listDocuments('683705ff00244f73e93f', '6838d38200133d8c3de0');
          document.getElementById("market-list").innerHTML = ads.documents.length
            ? ads.documents.map(ad => `
              <div class="border border-indigo-100 p-4 rounded-lg shadow my-2">
                <div class="font-bold text-lg mb-1">${ad.title}</div>
                <div class="text-xs mb-2">${ad.category} &bull; Goal: ${ad.goal} clicks</div>
                <a href="${ad.url}" target="_blank" class="text-blue-500 underline">Visit Advert</a>
              </div>
            `).join('')
            : "<div class='text-gray-500'>No adverts available. Upload one!</div>";
        };
        renderMarket();

        // Upload Advert modal
        document.getElementById("uploadAdvertBtn").onclick = () =>
          document.getElementById("uploadAdvertModal").classList.add("open");
        document.getElementById("uploadAdvertForm").onsubmit = async function(e) {
          e.preventDefault();
          await databases.createDocument('683705ff00244f73e93f', '6838d38200133d8c3de0', 'unique()', {
            title: document.getElementById('ad-title').value,
            category: document.getElementById('ad-category').value,
            goal: parseInt(document.getElementById('ad-clicks').value),
            url: document.getElementById('ad-url').value,
            poster: currentUser.$id
          });
          document.getElementById("uploadAdvertModal").classList.remove("open");
          renderMarket();
          this.reset();
        };

        // Copy invite link
        document.getElementById("copyInviteBtn").onclick = () => {
          navigator.clipboard.writeText(document.getElementById("invite-link").value);
          document.getElementById("copyInviteBtn").textContent = "Copied!";
          setTimeout(()=>{document.getElementById("copyInviteBtn").textContent="Copy Invite Link"},1200);
        };

        // Wallet tab connect logic (basic, with real contract integration)
        document.getElementById("connectWalletBtn").onclick = async function() {
          if(window.ethereum) {
            const provider = new ethers.BrowserProvider(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            const signer = await provider.getSigner();
            const address = await signer.getAddress();
            document.getElementById("wallet-address").textContent = address;
            const ethBalance = ethers.formatEther(await provider.getBalance(address));
            document.getElementById("eth-balance").textContent = Number(ethBalance).toFixed(4) + " ETH";
            // SupremeAmer token balance
            const saToken = new ethers.Contract(SUPREMEAMER_TOKEN_ADDRESS, SUPREMEAMER_TOKEN_ABI, provider);
            const saBal = await saToken.balanceOf(address);
            const saDec = await saToken.decimals();
            document.getElementById("sa-balance").textContent = "$SA " + ethers.formatUnits(saBal, saDec);
            document.getElementById("wallet-details").classList.remove("hidden");
            document.getElementById("connectWalletBtn").textContent = "Wallet Connected";
          } else {
            alert("Please install MetaMask or a compatible wallet.");
          }
        };

      } catch (e) {
        window.location.href = "TelegramLogin.html";
      }
    })();
  </script>
</body>
</html>
