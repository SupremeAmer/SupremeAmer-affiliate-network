i need the full implemtation guide and also add this: For security, consider also generating and checking codes on the backend (e.g., in Appwrite cloud functions) to prevent abuse. here is the code:<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SupremeAmer Affiliate Network</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --indigo: #4b0082;
      --purple: #7c43bd;
      --blue: #1a237e;
      --black: #000;
      --profile-gradient: linear-gradient(135deg, #0d1333 0%, #1a237e 40%, #000 100%);
      --transition: all 0.2s;
    }
    html, body {
      min-height: 100%;
      font-family: 'Inter', Arial, sans-serif;
      background: #f8f8f8;
      margin: 0;
      padding: 0;
    }
    body {
      background: linear-gradient(to bottom, #e0e7ff 0%, #fff 100%);
      padding-bottom: 80px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.25rem;
      background: linear-gradient(to right, #1a237e 0%, #7c43bd 100%);
      color: #fff;
      box-shadow: 0 2px 12px #1a237e33;
    }
    header img {
      width: 48px;
      height: 48px;
      border-radius: 9999px;
      border: 2px solid #fff;
      background: #fff;
    }
    .tab-btn {
      background: none;
      border: none;
      color: #222;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.75rem 0;
      border-radius: 8px;
      transition: var(--transition);
    }
    .tab-btn.active, .tab-btn:focus {
      background: linear-gradient(90deg, var(--indigo) 60%, var(--purple) 100%);
      color: #fff;
      outline: none;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .modal-bg {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(32,0,64,0.21); z-index: 1200; align-items: center; justify-content: center;
    }
    .modal-bg.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 18px;
      padding: 32px 27px;
      max-width: 95vw;
      min-width: 280px;
      box-shadow: 0 8px 36px #7c43bd28;
      color: #222;
      position: relative;
      transition: var(--transition);
    }
    .footer-nav {
      position: fixed; bottom: 0; left: 0; width: 100vw; z-index: 100;
      background: #fff; box-shadow: 0 -2px 16px #0001;
      display: flex; justify-content: space-around; align-items: center;
      padding: 1rem 0;
    }
    .welcome-card {
      animation: bounceIn 0.9s;
      background: #fff;
      border-radius: 18px;
      padding: 2rem 1.5rem;
      box-shadow: 0 4px 28px #7c43bd22;
      text-align: center;
      position: relative;
    }
    @keyframes bounceIn {
      0%{transform:scale(0.7);opacity:0;}
      80%{transform:scale(1.1);}
      100%{transform:scale(1);opacity:1;}
    }
    .close-modal, .close-modal:focus {
      background: #7c43bd;
      color: #fff;
      border: none;
      padding: 0.5rem 1.25rem;
      border-radius: 9px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 1rem;
      transition: background 0.2s;
    }
    .close-modal:hover { background: #4b0082; }
    /* Profile Modal Gradient */
    #profileModal .modal {
      background: var(--profile-gradient) !important;
      color: #f3f7fa !important;
      border: 1px solid #243a6e;
    }
    #profileModal .modal input, 
    #profileModal .modal div, 
    #profileModal .modal span, 
    #profileModal .modal button {
      color: #f3f7fa !important;
      background: transparent !important;
      border: none !important;
    }
    #profileModal .modal button {
      background: #101e53 !important;
      color: #fff !important;
    }
    #profileModal .modal b {
      color: #6cb9ff !important;
    }
    /* Utility */
    .rounded-xl { border-radius: 1rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded { border-radius: 0.25rem; }
    .shadow, .shadow-xl { box-shadow: 0 2px 6px #0001, 0 8px 36px #7c43bd14; }
    .shadow-lg { box-shadow: 0 8px 36px #7c43bd28; }
    .shadow-xl { box-shadow: 0 12px 48px #0002; }
    .p-7 { padding: 1.75rem; }
    .p-8 { padding: 2rem; }
    .p-4 { padding: 1rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .px-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-5 { margin-bottom: 1.25rem; }
    .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .my-3 { margin-top: 0.75rem; margin-bottom: 0.75rem; }
    .my-5 { margin-top: 1.25rem; margin-bottom: 1.25rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mt-4 { margin-top: 1rem; }
    .hidden { display: none !important; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .items-end { align-items: flex-end; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .font-bold { font-weight: bold; }
    .font-semibold { font-weight: 600; }
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-indigo-800 { color: #3730a3; }
    .text-indigo-900 { color: #312e81; }
    .text-green-600 { color: #16a34a; }
    .text-green-700 { color: #15803d; }
    .text-blue-500 { color: #3b82f6; }
    .text-blue-600 { color: #2563eb; }
    .text-blue-700 { color: #1d4ed8; }
    .text-orange-600 { color: #ea580c; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-700 { color: #374151; }
    .text-yellow-900 { color: #78350f; }
    .text-white { color: #fff; }
    .bg-white { background: #fff; }
    .bg-gray-100 { background: #f3f4f6; }
    .bg-gray-50 { background: #f9fafb; }
    .bg-yellow-50 { background: #fefce8; }
    .bg-green-500 { background: #22c55e; }
    .bg-green-600 { background: #16a34a; }
    .bg-blue-400 { background: #60a5fa; }
    .bg-blue-600 { background: #2563eb; }
    .bg-blue-700 { background: #1d4ed8; }
    .bg-orange-600 { background: #ea580c; }
    .bg-purple-600 { background: #7c43bd; }
    .bg-indigo-50 { background: #eef2ff; }
    .bg-indigo-600 { background: #4f46e5; }
    .bg-indigo-800 { background: #3730a3; }
    .bg-yellow-500 { background: #eab308; }
    .bg-gray-600 { background: #4b5563; }
    .bg-black { background: #000; }
    .bg-opacity-40 { background: rgba(0,0,0,0.4); }
    .border { border: 1px solid #e5e7eb; }
    .border-indigo-100 { border-color: #e0e7ff; }
    .border-yellow-300 { border-color: #fde68a; }
    .border-white { border-color: #fff; }
    .border-gray-500 { border-color: #6b7280; }
    .border-indigo-200 { border-color: #c7d2fe; }
    .block { display: block; }
    .w-full { width: 100%; }
    .w-12 { width: 3rem; }
    .w-20 { width: 5rem; }
    .w-28 { width: 7rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .max-w-xs { max-width: 20rem; }
    .max-w-md { max-width: 28rem; }
    .max-w-3xl { max-width: 48rem; }
    .select-all { user-select: all; }
    .cursor-pointer { cursor: pointer; }
    .transition { transition: var(--transition); }
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .opacity-80 { opacity: 0.8; }
    .opacity-90 { opacity: 0.9; }
    .fixed { position: fixed; }
    .relative { position: relative; }
    .inset-0 { left: 0; right: 0; top: 0; bottom: 0; }
    .top-1 { top: 0.25rem; }
    .right-2 { right: 0.5rem; }
    .top-12 { top: 3rem; }
    .top-20 { top: 5rem; }
    .left-1\/2 { left: 50%; }
    .-translate-x-1\/2 { transform: translateX(-50%); }
    .z-40 { z-index: 40; }
    .z-50 { z-index: 50; }
    .z-100 { z-index: 100; }
    .z-1200 { z-index: 1200; }
    .overflow-x-auto { overflow-x: auto; }
    .overflow-hidden { overflow: hidden; }
    @media (max-width: 640px) {
      header, main, .modal, .welcome-card { padding-left: 0.5rem; padding-right: 0.5rem;}
      .max-w-3xl { max-width: 97vw; }
    }
    
  </style>
</head>
<body class="min-h-screen pb-20 bg-gradient-to-b from-indigo-50 to-white">

  <!-- HEADER -->
  <header class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-indigo-900 to-purple-700 shadow text-white">
    <div class="flex items-center gap-2">
      <img src="logo.png" alt="Logo" class="w-12 h-12 rounded-full border-2 border-white" />
      <div>
        <div class="text-2xl font-bold tracking-wide">SupremeAmer</div>
        <div class="text-xs opacity-90">Affiliate Network for Smart Earners & Advertisers</div>
      </div>
    </div>
    <div class="flex flex-col items-end">
      <span id="user-email" class="text-xs opacity-80 truncate max-w-xs"></span>
      <span id="user-username" class="text-lg font-semibold"></span>
      <div class="flex items-center gap-2">
        <button id="profileBtn" class="text-2xl rounded-full hover:bg-indigo-800 transition p-1" aria-label="Profile">&#x263A;</button>
        <button id="logoutBtn" class="text-red-600 px-3 py-1 rounded-lg bg-white hover:bg-red-600 hover:text-white transition" aria-label="Logout">Logout</button>
      </div>
    </div>
    <div id="profileModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
      <div class="modal max-w-md">
        <h3 class="font-bold mb-2 text-indigo-800 text-lg">Your Profile</h3>
        <div><b>ID:</b> <span id="user-id" class="truncate"></span></div>
        <div><b>Username:</b> <span id="user-username-modal"></span></div>
        <div><b>Email:</b> <span id="user-email-modal"></span></div>
        <div class="mt-3"><b>Your Invitation Link:</b>
          <div class="bg-gray-100 rounded px-3 py-1 mt-1 select-all" id="invitation-url"></div>
          <div class="flex gap-2 mt-2">
            <button id="copyProfileInviteBtn" class="bg-green-600 text-white px-3 py-1 rounded">Copy</button>
            <button id="showQrBtn" class="bg-blue-600 text-white px-3 py-1 rounded">QR Code</button>
          </div>
          <div id="inviteQrWrap" class="mt-2 hidden">
            <img id="inviteQr" alt="Invite QR" class="mx-auto"/>
          </div>
        </div>
        <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Close Profile Modal">Close</button>
      </div>
    </div>
  </header>

  <!-- WELCOME CARD -->
  <div id="welcomeCard" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
    <div class="welcome-card bg-white p-8 rounded-xl shadow-xl text-center relative max-w-xs mx-auto animate-bounce">
      <img src="logo.png" class="mx-auto mb-4 w-20" alt="Logo" />
      <h2 class="text-xl font-bold mb-2 text-indigo-900">Welcome to SupremeAmer!</h2>
      <p class="mb-4">Congrats! You just earned a <b class="text-green-700">$SA250</b> bonus for joining.</p>
      <button id="dismissWelcome" class="bg-purple-600 text-white px-6 py-2 rounded transition hover:bg-indigo-700" aria-label="Dismiss Welcome">Let's Go!</button>
      <span class="absolute top-1 right-2 text-2xl cursor-pointer" id="closeWelcome" title="Close">&times;</span>
    </div>
  </div>

  <!-- PENDING REWARDS -->
  <div id="pendingRewardsNotice" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-40 bg-yellow-50 border border-yellow-300 text-yellow-900 px-6 py-3 rounded-xl shadow-lg hidden">
    <span>Pending reward: <b id="pendingRewardAmt">$SA0</b>. Will be credited after verification.</span>
  </div>

  <!-- SCREENSHOT MODAL -->
  <div id="screenshotModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
    <div class="modal text-center">
      <h3 class="font-bold mb-2 text-indigo-800">Upload Screenshot Proof</h3>
      <input type="file" id="proofFile" accept="image/*" class="mb-3 block mx-auto" />
      <button id="submitProofBtn" class="bg-green-600 text-white px-5 py-2 rounded">Submit Proof</button>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Cancel">Cancel</button>
    </div>
  </div>

  <!-- MAIN TABS -->
  <main class="pt-3 pb-24 max-w-3xl mx-auto">

    <!-- DASHBOARD -->
    <section id="homeTab" class="tab-content active bg-white rounded-xl shadow p-7 my-3" aria-labelledby="home-tab-btn">
      <h2 class="text-xl font-bold mb-3 text-indigo-900">Dashboard Overview</h2>
      <div class="text-gray-800 font-semibold mb-1">Account Balance</div>
      <div class="text-3xl text-indigo-800 font-bold mb-2" id="account-balance">$SA 0</div>
      <div class="flex gap-4 mb-4">
        <button class="bg-blue-600 text-white px-5 py-2 rounded" id="fundBtn">Fund</button>
        <button class="bg-green-600 text-white px-5 py-2 rounded" id="cashoutBtn">Withdraw</button>
        <button class="bg-orange-600 text-white px-5 py-2 rounded" id="paymentHistoryBtn">Payment History</button>
      </div>
      <div id="dashboard-content"></div>
    </section>

    <!-- MARKETPLACE -->
    <section id="marketTab" class="tab-content bg-white rounded-xl shadow p-7 my-3" aria-labelledby="market-tab-btn">
      <h2 class="text-xl font-bold mb-3 text-indigo-900">Marketplace</h2>
      <div class="flex flex-col md:flex-row md:items-center gap-3 mb-3">
        <input id="marketSearch" type="text" placeholder="Search by keyword or category..." class="border rounded px-3 py-1 w-full md:w-1/3" />
        <select id="marketSort" class="border rounded px-3 py-1">
          <option value="newest">Newest</option>
          <option value="goal">Goal (Highest)</option>
          <option value="clicks">Most Clicks</option>
        </select>
      </div>
      <div id="market-list" class="mb-5"></div>
      <button id="uploadAdvertBtn" class="bg-indigo-600 text-white px-6 py-2 rounded mb-2">Upload Advert</button>
      <div id="uploadAdvertModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
        <div class="modal max-w-lg">
          <h3 class="font-bold mb-2 text-indigo-800">Upload Advert</h3>
          <form id="uploadAdvertForm" class="flex flex-col gap-3">
            <input type="text" id="ad-title" class="border rounded px-3 py-2" placeholder="Advert Title (max 60 chars)" required maxlength="60" autocomplete="off" />
            <select id="ad-category" class="border rounded px-3 py-2" required>
              <option value="">Select Category</option>
              <option value="Social Media">Social Media</option>
              <option value="Referral">Referral</option>
              <option value="Video/Content">Video/Content</option>
              <option value="Crypto">Crypto</option>
              <option value="Others">Others</option>
            </select>
            <input type="number" id="ad-clicks" class="border rounded px-3 py-2" min="50" max="10000" placeholder="Clicks (min 50, max 10000)" required />
            <input type="url" id="ad-url" class="border rounded px-3 py-2" placeholder="Advert URL" required autocomplete="off" />
            <input type="file" id="ad-image" accept="image/*" class="border rounded px-3 py-2" />
            <textarea id="ad-instructions" class="border rounded px-3 py-2" placeholder="Participation Instructions (e.g., post a comment, like, etc.)" required></textarea>
            <div id="ad-cost" class="text-sm text-indigo-700 my-2"></div>
            <div id="ad-preview" class="my-2 hidden">
              <span class="font-bold">Preview:</span>
              <div id="ad-preview-content" class="border p-2 rounded bg-gray-50"></div>
            </div>
            <button type="button" id="previewAdBtn" class="bg-gray-300 text-indigo-900 px-5 py-2 rounded">Preview</button>
            <button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded">Submit Advert</button>
          </form>
          <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Cancel Upload Advert">Cancel</button>
        </div>
      </div>
    </section>

    <!-- INVITE -->
    <section id="inviteTab" class="tab-content bg-white rounded-xl shadow p-7 my-3" aria-labelledby="invite-tab-btn">
      <h2 class="text-xl font-bold mb-3 text-indigo-900">Invite Friends</h2>
      <div class="mb-3">Share your unique invitation link to earn rewards!</div>
      <input type="text" readonly class="w-full border rounded px-3 py-2 mb-3 bg-gray-100" id="invite-link" />
      <div class="flex gap-2 mb-4">
        <button class="bg-green-600 text-white px-5 py-2 rounded" id="copyInviteBtn">Copy Invite Link</button>
        <button class="bg-blue-600 text-white px-5 py-2 rounded" id="inviteQrBtn">QR Code</button>
        <button class="bg-gray-600 text-white px-5 py-2 rounded" id="shareButtonsBtn">Share</button>
      </div>
      <div id="inviteQrContainer" class="mb-4 hidden">
        <img id="inviteQrImg" alt="QR Code" class="mx-auto" />
      </div>
      <div id="inviteShareBtns" class="flex gap-2 mb-4 hidden">
        <a id="whatsappShare" class="bg-green-500 text-white px-3 py-1 rounded" target="_blank">WhatsApp</a>
        <a id="telegramShare" class="bg-blue-400 text-white px-3 py-1 rounded" target="_blank">Telegram</a>
        <a id="twitterShare" class="bg-gray-700 text-white px-3 py-1 rounded" target="_blank">X/Twitter</a>
        <a id="facebookShare" class="bg-blue-700 text-white px-3 py-1 rounded" target="_blank">Facebook</a>
      </div>
      <div class="my-5">
        <h3 class="font-semibold mb-2 text-indigo-800">Your Invited Friends</h3>
        <div id="invitee-list"></div>
      </div>
      <div class="my-5">
        <h3 class="font-semibold mb-2 text-indigo-800">Referral Leaderboard</h3>
        <div id="referral-leaderboard"></div>
      </div>
      <div class="my-5">
        <h3 class="font-semibold mb-2 text-indigo-800">Your Referral Stats</h3>
        <div id="referral-analytics"></div>
      </div>
    </section>

    <!-- WALLET -->
    <section id="walletTab" class="tab-content bg-white rounded-xl shadow p-7 my-3" aria-labelledby="wallet-tab-btn">
      <h2 class="text-xl font-bold mb-3 text-indigo-900">Wallet</h2>
      <div class="mb-2">
        <span id="walletStatus" class="font-semibold"></span>
        <button id="disconnectWalletBtn" class="bg-red-600 text-white px-3 py-1 rounded ml-3 hidden">Disconnect</button>
      </div>
      <button id="connectWalletBtn" class="bg-yellow-400 hover:bg-yellow-500 transition text-black px-4 py-2 rounded">Connect Wallet</button>
      <div id="wallet-details" class="hidden mt-3 border border-indigo-200 rounded p-3 bg-indigo-50 text-indigo-900">
        <div><b>Provider:</b> <span id="wallet-provider"></span></div>
        <div><b>Wallet Address:</b> <span id="wallet-address"></span></div>
        <div><b>BNB Balance:</b> <span id="eth-balance"></span></div>
        <div><b>$SA Balance:</b> <span id="sa-balance"></span></div>
        <div><b>Network:</b> <span id="wallet-network"></span></div>
      </div>
    </section>
  </main>

  <nav class="footer-nav flex justify-around py-3 border-t bg-white" aria-label="Footer Navigation">
    <button class="tab-btn flex-1 py-2 rounded mx-1 active" id="home-tab-btn" data-tab="homeTab" aria-controls="homeTab" aria-selected="true">Home</button>
    <button class="tab-btn flex-1 py-2 rounded mx-1" id="market-tab-btn" data-tab="marketTab" aria-controls="marketTab">Market</button>
    <button class="tab-btn flex-1 py-2 rounded mx-1" id="invite-tab-btn" data-tab="inviteTab" aria-controls="inviteTab">Invite</button>
    <button class="tab-btn flex-1 py-2 rounded mx-1" id="wallet-tab-btn" data-tab="walletTab" aria-controls="walletTab">Wallet</button>
    <button class="tab-btn flex-1 py-2 rounded mx-1" id="helpSupportBtn">Help & Support</button>
  </nav>

  <!-- PAYMENT HISTORY MODAL -->
  <div id="paymentHistoryModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
    <div class="modal">
      <h3 class="font-bold mb-2 text-indigo-800">Payment History</h3>
      <div id="payment-history-content"></div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Close Payment History">Close</button>
    </div>
  </div>
  <div id="helpSupportModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
    <div class="modal">
      <h3 class="font-bold mb-2 text-indigo-800">Help & Support</h3>
      <div class="mb-2">Email: <a href="mailto:support@supremeamer.com" class="text-blue-600 underline">support@supremeamer.com</a></div>
      <div class="mb-2">AI Quick Response:<br><span class="italic text-gray-700">"How can we help? Describe your issue and our AI will provide a quick answer or escalate to a human!"</span></div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Close Help & Support">Close</button>
    </div>
  </div>
  <div id="adminReviewPanel" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1" style="display:none;">
    <div class="modal">
      <h3 class="font-bold mb-2 text-indigo-800">Proof Review Panel</h3>
      <div id="admin-review-list"></div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" onclick="closeModal('adminReviewPanel')">Close</button>
    </div>
  </div>
  <div id="fundModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
    <div class="modal text-center">
      <h3 class="font-bold mb-2 text-indigo-800">Fund Your Account</h3>
      <div>
        <label class="block text-left mb-1 font-medium">Amount (BNB):</label>
        <input type="number" id="fundAmount" min="0.001" step="0.001" class="border rounded px-3 py-2 w-full mb-2" placeholder="Min 0.001" />
      </div>
      <button id="payWithEthBtn" class="bg-yellow-500 text-black px-5 py-2 rounded my-1 w-full">Pay with BNB</button>
      <button id="payWithSaBtn" class="bg-indigo-600 text-white px-5 py-2 rounded my-1 w-full">$SA Token</button>
      <div class="text-xs text-gray-500 mt-3">Funds are credited after transaction confirmation. $SA tokens credited instantly.</div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Cancel Fund">Cancel</button>
    </div>
  </div>
  <div id="cashoutModal" class="modal-bg" aria-modal="true" role="dialog" tabindex="-1">
    <div class="modal text-center">
      <h3 class="font-bold mb-2 text-indigo-800">Withdraw Request</h3>
      <div>
        <label class="block text-left mb-1 font-medium">Amount:</label>
        <input type="number" id="cashoutAmount" min="0.001" step="0.001" class="border rounded px-3 py-2 w-full mb-2" placeholder="Enter amount" />
      </div>
      <div>
        <label class="block text-left mb-1 font-medium">Asset:</label>
        <select id="cashoutAsset" class="border rounded px-3 py-2 w-full mb-2">
          <option value="BNB">BNB</option>
          <option value="SA">$SA</option>
        </select>
      </div>
      <button id="requestCashoutBtn" class="bg-green-600 text-white px-5 py-2 rounded my-1 w-full">Request Withdraw</button>
      <div class="text-xs text-gray-600 mt-3">Withdrawals are automatic for $SA (min 5000), BNB requests are processed to your connected wallet. You will be notified by email.</div>
      <button class="mt-4 bg-purple-600 text-white py-2 px-5 rounded close-modal" aria-label="Cancel Cashout">Cancel</button>
    </div>
  </div>
  <script>
    // CONFIGURATION (update for your deployment)
    const tokenAbi = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function transfer(address to, uint256 amount) returns (bool)"
    ];
    const tokenAddress = "0xYourSupremeAmerBnbTokenAddress"; // PUT your real BNB token address here
    const fundRecipientAddress = "0xYourAdminTreasuryBnbAddress"; // PUT your real admin/treasury address here
    const dbId = '683705ff00244f73e93f';
    const usersColl = 'users', txColl = 'transaction_collection', advertsColl = 'adverts', partsColl = 'participations';

    // APPWRITE SETUP
    const client = new Appwrite.Client();
    client.setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('68370442000c3c15b9f3');
    const account = new Appwrite.Account(client);
    const databases = new Appwrite.Databases(client);
    const storage = new Appwrite.Storage(client);

    // STATE
    let provider = null, signer = null, currentAddress = null, currentUser = null, userDocId = null, userDoc = null;
    let marketAdverts = [];
    let pendingParticipation = null;

    // TABS
    document.querySelectorAll(".tab-btn[data-tab]").forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        this.classList.add("active");
        document.querySelectorAll(".tab-content").forEach(tc=>tc.classList.remove("active"));
        if(this.dataset.tab) document.getElementById(this.dataset.tab).classList.add("active");
        document.querySelectorAll(".tab-btn").forEach(b=>b.setAttribute('aria-selected', 'false'));
        this.setAttribute('aria-selected', 'true');
      });
    });

    // MODALS & NOTIFICATIONS
    function closeModal(modalId) { document.getElementById(modalId).classList.remove("open"); }
    function openModal(modalId) { document.getElementById(modalId).classList.add("open"); }
    document.querySelectorAll(".close-modal").forEach(btn =>
      btn.onclick = () => btn.closest(".modal-bg").classList.remove("open")
    );
    document.getElementById("profileBtn").onclick = () => openModal("profileModal");
    document.getElementById("helpSupportBtn").onclick = () => openModal("helpSupportModal");
    function showNotification(msg, color="green") {
      const notice = document.createElement("div");
      notice.className = `fixed top-12 right-6 bg-${color}-600 text-white px-5 py-2 rounded shadow-lg z-50`;
      notice.innerText = msg;
      document.body.appendChild(notice);
      setTimeout(() => notice.remove(), 4000);
    }

    // LOGOUT
    document.getElementById("logoutBtn").onclick = async () => {
      await account.deleteSession('current');
      window.location.reload();
    };

    // UTILS
    function generateQr(data, el) {
      const qr = new QRious({ value: data, size: 160 });
      el.src = qr.toDataURL();
    }
    function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

    // WALLET LOGIC (BNB)
    async function connectWallet() {
      if (!window.ethereum) {
        alert("Install MetaMask.");
        return;
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });
      signer = await provider.getSigner();
      currentAddress = await signer.getAddress();
      const net = (await provider.getNetwork()).name;
      document.getElementById("walletStatus").textContent = "Wallet Connected";
      document.getElementById("connectWalletBtn").textContent = "Wallet Connected";
      document.getElementById("disconnectWalletBtn").classList.remove("hidden");
      updateWalletDisplay(currentAddress, net);
    }
    async function updateWalletDisplay(address, net) {
      document.getElementById("wallet-address").textContent = address || "";
      document.getElementById("wallet-network").textContent = net || "";
      if (provider && address) {
        const bnbBalance = ethers.formatEther(await provider.getBalance(address));
        document.getElementById("eth-balance").textContent = Number(bnbBalance).toFixed(4) + " BNB";
        await loadSaBalance(address);
      }
      document.getElementById("wallet-provider").textContent = window.ethereum && window.ethereum.isMetaMask ? "MetaMask" : "Unknown";
      document.getElementById("wallet-details").classList.remove("hidden");
    }
    async function loadSaBalance(address) {
      if (window.ethers && tokenAddress && tokenAbi && address && provider) {
        const contract = new ethers.Contract(tokenAddress, tokenAbi, provider);
        const saBalance = await contract.balanceOf(address);
        const decimals = await contract.decimals();
        document.getElementById("sa-balance").textContent =
          ethers.formatUnits(saBalance, decimals) + " $SA";
      }
    }
    document.getElementById("connectWalletBtn").onclick = connectWallet;
    document.getElementById("disconnectWalletBtn").onclick = () => {
      provider = signer = null;
      currentAddress = null;
      document.getElementById("walletStatus").textContent = "Wallet Disconnected";
      document.getElementById("wallet-details").classList.add("hidden");
      document.getElementById("connectWalletBtn").textContent = "Connect Wallet";
      document.getElementById("disconnectWalletBtn").classList.add("hidden");
    };
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', () => { if (currentAddress) connectWallet(); });
      window.ethereum.on('chainChanged', () => { if (currentAddress) connectWallet(); });
    }

    // FUND WALLET
    document.getElementById("fundBtn").onclick = () => openModal("fundModal");
    document.getElementById("payWithEthBtn").onclick = async () => {
      if (!signer || !currentAddress) { alert("Connect your wallet first!"); return; }
      const amt = parseFloat(document.getElementById("fundAmount").value);
      if (isNaN(amt) || amt < 0.001) { alert("Enter a valid amount (min 0.001 BNB)."); return; }
      try {
        document.getElementById("payWithEthBtn").disabled = true;
        showNotification("Awaiting wallet signature...", "yellow");
        const tx = await signer.sendTransaction({
          to: fundRecipientAddress,
          value: ethers.parseEther(amt.toString())
        });
        showNotification("Waiting for confirmation...", "yellow");
        await tx.wait();
        showNotification("Funded! Await admin credit.", "green");
        await databases.createDocument(dbId, txColl, 'unique()', {
          userId: currentUser.$id,
          type: "fund",
          amount: amt,
          date: new Date().toISOString(),
          description: "BNB Fund (on-chain)",
          status: "pending",
          txHash: tx.hash
        });
        closeModal("fundModal");
      } catch (e) {
        alert("Transaction failed: " + (e && e.message ? e.message : e));
      } finally {
        document.getElementById("payWithEthBtn").disabled = false;
      }
    };
    document.getElementById("payWithSaBtn").onclick = async () => {
      if (!signer || !currentAddress) { alert("Connect your wallet!"); return; }
      const amt = parseFloat(document.getElementById("fundAmount").value);
      if (isNaN(amt) || amt <= 0) { alert("Amount required."); return; }
      try {
        document.getElementById("payWithSaBtn").disabled = true;
        const contract = new ethers.Contract(tokenAddress, tokenAbi, signer);
        const decimals = await contract.decimals();
        const tx = await contract.transfer(fundRecipientAddress, ethers.parseUnits(amt.toString(), decimals));
        showNotification("Waiting for $SA confirmation...", "yellow");
        await tx.wait();
        showNotification("$SA sent! Await admin credit.", "green");
        await databases.createDocument(dbId, txColl, 'unique()', {
          userId: currentUser.$id,
          type: "fund-sa",
          amount: amt,
          date: new Date().toISOString(),
          description: "$SA Fund (on-chain)",
          status: "pending",
          txHash: tx.hash
        });
        closeModal("fundModal");
      } catch (e) {
        alert("Transaction failed: " + (e && e.message ? e.message : e));
      } finally {
        document.getElementById("payWithSaBtn").disabled = false;
      }
    };

    // CASHOUT REQUEST
    document.getElementById("cashoutBtn").onclick = () => openModal("cashoutModal");
    document.getElementById("requestCashoutBtn").onclick = async () => {
      if (!signer || !currentAddress) { alert("Connect your wallet!"); return; }
      const amt = parseFloat(document.getElementById("cashoutAmount").value);
      const asset = document.getElementById("cashoutAsset").value;
      if (asset === "SA" && (isNaN(amt) || amt < 5000)) {
        alert("Minimum $SA withdraw is 5000."); return;
      }
      if (asset === "BNB" && (isNaN(amt) || amt < 0.001)) {
        alert("Minimum BNB withdraw is 0.001."); return;
      }
      await databases.createDocument(dbId, txColl, 'unique()', {
        userId: currentUser.$id,
        type: asset === "SA" ? "sa-cashout-request" : "bnb-cashout-request",
        amount: -amt,
        date: new Date().toISOString(),
        description: asset + " cashout request to wallet: " + currentAddress,
        status: "pending",
        wallet: currentAddress
      });
      showNotification(asset + " cashout request sent. Await admin transfer.", "green");
      closeModal("cashoutModal");
    };

    // PROFILE/INVITE UI
    function setupReferralLinks() {
      // Use inviteCode for referral
      const baseInvite = userDoc.inviteCode || currentUser.$id;
      const inviteUrl = window.location.origin + "/register.html?invite=" + baseInvite;
      document.getElementById("invitation-url").textContent = inviteUrl;
      document.getElementById("invite-link").value = inviteUrl;
      document.getElementById("copyProfileInviteBtn").onclick = () => {
        navigator.clipboard.writeText(inviteUrl);
        document.getElementById("copyProfileInviteBtn").textContent = "Copied!";
        setTimeout(()=>{document.getElementById("copyProfileInviteBtn").textContent="Copy"},1200);
      };
      document.getElementById("showQrBtn").onclick = () => {
        generateQr(inviteUrl, document.getElementById("inviteQr"));
        document.getElementById("inviteQrWrap").classList.toggle("hidden");
      };
      document.getElementById("copyInviteBtn").onclick = () => {
        navigator.clipboard.writeText(inviteUrl);
        document.getElementById("copyInviteBtn").textContent = "Copied!";
        setTimeout(()=>{document.getElementById("copyInviteBtn").textContent="Copy Invite Link"},1200);
      };
      document.getElementById("inviteQrBtn").onclick = () => {
        generateQr(inviteUrl, document.getElementById("inviteQrImg"));
        document.getElementById("inviteQrContainer").classList.toggle("hidden");
      };
      document.getElementById("shareButtonsBtn").onclick = () => {
        const c = document.getElementById("inviteShareBtns");
        c.classList.toggle("hidden");
      };
      const shareMsg = encodeURIComponent("Join SupremeAmer and earn rewards! " + inviteUrl);
      document.getElementById("whatsappShare").href = `https://wa.me/?text=${shareMsg}`;
      document.getElementById("telegramShare").href = `https://t.me/share/url?url=${inviteUrl}&text=Join%20SupremeAmer%20and%20earn%20rewards!`;
      document.getElementById("twitterShare").href = `https://twitter.com/intent/tweet?text=${shareMsg}`;
      document.getElementById("facebookShare").href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(inviteUrl)}`;
    }

    // REFERRAL CODE GENERATION
    async function generateUniqueInviteCode(username, userId) {
      let letters = username.replace(/[^a-zA-Z]/g, '').substring(0,3).toUpperCase().padEnd(3, 'X');
      let nums = (userId.match(/\d{5,}/) || [userId.slice(-5)])[0].slice(-5);
      let code = letters + nums;
      let exists = await databases.listDocuments(dbId, usersColl, [Appwrite.Query.equal('inviteCode', code)]);
      if (exists.documents.length) code += Math.floor(Math.random()*10);
      return code;
    }

    // REFERRAL BONUS AND MULTI-LEVEL
    async function creditReferralCommission(userId) {
      let user = await databases.getDocument(dbId, usersColl, userId);
      let inviterId = user.invitedBy;
      let level = 1;
      while (inviterId && level <= 3) {
        let commission = level === 1 ? 100 : (level === 2 ? 50 : 25);
        await databases.createDocument(dbId, txColl, 'unique()', {
          userId: inviterId,
          type: "credit",
          amount: commission,
          date: new Date().toISOString(),
          description: `Level ${level} referral reward for user ${userId}`,
          status: "completed"
        });
        let inviter = await databases.getDocument(dbId, usersColl, inviterId);
        inviterId = inviter.invitedBy;
        level++;
      }
    }

    // WELCOME BONUS
    async function showWelcomeCardIfNeeded() {
      if (!userDoc.welcomeBonus) {
        document.getElementById("welcomeCard").classList.remove("hidden");
        const dismissWelcome = async () => {
          document.getElementById("welcomeCard").classList.add("hidden");
          await databases.createDocument(dbId, txColl, 'unique()', {
            userId: currentUser.$id,
            type: "credit",
            amount: 250,
            date: new Date().toISOString(),
            description: "Welcome Bonus",
            status: "completed"
          });
          await databases.updateDocument(dbId, usersColl, userDocId, { welcomeBonus: true });
          await creditReferralCommission(currentUser.$id);
          await loadBalance();
        };
        document.getElementById("dismissWelcome").onclick = dismissWelcome;
        document.getElementById("closeWelcome").onclick = dismissWelcome;
        document.getElementById("welcomeCard").onclick = e => { if (e.target === document.getElementById("welcomeCard")) dismissWelcome(); };
      }
    }

    // LOAD BALANCE, PAYMENT HISTORY
    async function loadBalance() {
      const txs = await databases.listDocuments(dbId, txColl, [
        Appwrite.Query.equal('userId', currentUser.$id)
      ]);
      let balance = txs.documents.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0);
      document.getElementById("account-balance").textContent = `$SA ${balance}`;
    }
    document.getElementById("paymentHistoryBtn").onclick = async () => {
      const txs = await databases.listDocuments(dbId, txColl, [
        Appwrite.Query.equal('userId', currentUser.$id)
      ]);
      document.getElementById("payment-history-content").innerHTML =
        "<ul class='list-disc ml-5'>" + txs.documents.map(
          tx => `<li>${tx.date}: <span class="text-green-700">${tx.type}</span> <b>${tx.amount}</b> (${tx.description || ""})</li>`
        ).join("") + "</ul>";
      openModal("paymentHistoryModal");
    };

    // LEADERBOARD & REFERRAL ANALYTICS
    async function renderLeaderboard() {
      let allUsers = await databases.listDocuments(dbId, usersColl, []);
      let leaderboard = allUsers.documents
        .map(u => ({
          name: u.name || u.email,
          count: allUsers.documents.filter(us => us.invitedBy === u.$id).length
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
      document.getElementById("referral-leaderboard").innerHTML =
        leaderboard.map((u, i) => `<div>${i + 1}. ${u.name} - <b>${u.count}</b> referrals</div>`).join('');
    }
    async function renderReferralAnalytics() {
      let allUsers = await databases.listDocuments(dbId, usersColl, []);
      let myReferrals = allUsers.documents.filter(u => u.invitedBy === currentUser.$id);
      let txs = await databases.listDocuments(dbId, txColl, [
        Appwrite.Query.equal('userId', currentUser.$id),
        Appwrite.Query.search('description', 'referral reward')
      ]);
      document.getElementById("referral-analytics").innerHTML = `
        <div>Total Invites: <b>${myReferrals.length}</b></div>
        <div>Total Referral Commissions: <b>$SA${txs.documents.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0)}</b></div>
      `;
    }

    // MARKET
    async function renderMarket() {
      let docs = await databases.listDocuments(dbId, advertsColl, [
        Appwrite.Query.equal('active', true)
      ]);
      marketAdverts = docs.documents;
      const sort = document.getElementById("marketSort").value;
      if (sort === "goal") marketAdverts.sort((a,b)=>b.goal-a.goal);
      if (sort === "clicks") marketAdverts.sort((a,b)=>b.clicks-a.clicks);
      if (sort === "newest") marketAdverts.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
      const search = document.getElementById("marketSearch").value.toLowerCase().trim();
      let adsToShow = marketAdverts;
      if (search) {
        adsToShow = marketAdverts.filter(ad =>
          (ad.title && ad.title.toLowerCase().includes(search)) ||
          (ad.category && ad.category.toLowerCase().includes(search))
        );
      }
      document.getElementById("market-list").innerHTML = adsToShow.length
        ? adsToShow.map(ad => `
          <div class="border border-indigo-100 p-4 rounded-lg shadow my-2 flex flex-col md:flex-row md:items-center justify-between transition-all duration-200">
            <div class="flex-1">
              ${(ad.imageUrl ? `<img src="${ad.imageUrl}" class="w-28 mb-2 rounded" alt="ad"/>` : "")}
              <div class="font-bold text-lg mb-1">${ad.title}</div>
              <div class="text-xs mb-2">${ad.category} &bull; Goal: ${ad.goal} clicks &bull; Clicks: ${ad.clicks || 0}/${ad.maxClicks}</div>
              <div class="mb-1 text-sm text-indigo-800"><b>Instructions:</b> ${ad.instructions || ""}</div>
              <a href="${ad.url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">Visit Advert</a>
            </div>
            <button class="bg-green-500 text-white px-3 py-1 rounded participate-btn mt-2 md:mt-0" data-adid="${ad.$id}">Participate</button>
          </div>
        `).join('')
        : "<div class='text-gray-500'>No adverts available. Upload one!</div>";
      document.querySelectorAll('.participate-btn').forEach(btn => {
        btn.onclick = async function() {
          pendingParticipation = btn.getAttribute('data-adid');
          const can = await canParticipate(pendingParticipation, currentUser.$id);
          if (!can) {
            alert("You have already participated in this advert.");
            return;
          }
          openModal("screenshotModal");
        };
      });
    }
    document.getElementById("marketSearch").oninput = renderMarket;
    document.getElementById("marketSort").onchange = renderMarket;

    // PARTICIPATION LIMIT
    async function canParticipate(advertId, userId) {
      let participations = await databases.listDocuments(dbId, partsColl, [
        Appwrite.Query.equal('userId', userId),
        Appwrite.Query.equal('advertId', advertId)
      ]);
      return participations.documents.length === 0;
    }

    // PROOF SUBMIT (50 SA, pending, released after 10min)
    document.getElementById("submitProofBtn").onclick = async function() {
      const fileInput = document.getElementById('proofFile');
      if (!fileInput.files[0]) return alert("Please select a screenshot!");
      let file = fileInput.files[0];
      let up = await storage.createFile(dbId, 'adproofs', 'unique()', file);
      let proofUrl = storage.getFileView(dbId, 'adproofs', up.$id).href;
      let ad = marketAdverts.find(a => a.$id === pendingParticipation);
      let reward = 50; // Fixed
      await databases.createDocument(dbId, partsColl, 'unique()', {
        advertId: ad.$id,
        userId: currentUser.$id,
        posterId: ad.poster,
        screenshotUrl: proofUrl,
        status: "pending",
        joinedAt: new Date().toISOString(),
        rewardAmount: reward
      });
      await databases.updateDocument(dbId, advertsColl, ad.$id, {
        clicks: (ad.clicks || 0) + 1
      });
      if ((ad.clicks || 0) + 1 >= ad.maxClicks) {
        await databases.updateDocument(dbId, advertsColl, ad.$id, {active: false});
      }
      closeModal("screenshotModal");
      document.getElementById("pendingRewardsNotice").classList.remove("hidden");
      document.getElementById("pendingRewardAmt").textContent = "$SA" + reward;
      setTimeout(() => document.getElementById("pendingRewardsNotice").classList.add("hidden"), 5000);
      setTimeout(async () => {
        await databases.createDocument(dbId, txColl, 'unique()', {
          userId: currentUser.$id,
          type: "credit",
          amount: reward,
          date: new Date().toISOString(),
          description: "Advert reward",
          status: "completed"
        });
        await loadBalance();
      }, 10 * 60 * 1000); // 10min
      await renderMarket();
    };

    // UPLOAD ADVERT (fee is 0.00002 BNB per click, min 50, fee paid to admin)
    document.getElementById("uploadAdvertBtn").onclick = () => openModal("uploadAdvertModal");
document.getElementById("uploadAdvertForm").onsubmit = async function(e) {
  e.preventDefault();
  const title = document.getElementById('ad-title').value.trim();
  const category = document.getElementById('ad-category').value;
  const clicks = parseInt(document.getElementById('ad-clicks').value);
  const cost = clicks * 0.00002;
  const url = document.getElementById('ad-url').value.trim();
  const instructions = document.getElementById('ad-instructions').value;
  const imageInput = document.getElementById('ad-image');

  if (title.length < 3) return alert("Title is too short.");
  if (!/^https?:\/\//.test(url)) return alert("URL must start with http:// or https://");
  if (clicks < 50 || clicks > 10000) return alert("Clicks must be between 50 and 10000.");
  if (!instructions.trim()) return alert("Instructions are required.");

  const allowedEmails = [
    "supremealpha04@gmail.com",
    "supremeamerapplications@gmail.com"
  ];

  if (allowedEmails.includes(currentUser.email)) {
    // Allowed emails: upload without payment
    try {
      document.getElementById("uploadAdvertBtn").disabled = true;
      let imageUrl = "";
      if (imageInput.files && imageInput.files[0]) {
        const upImg = await storage.createFile(dbId, 'adimages', 'unique()', imageInput.files[0]);
        imageUrl = storage.getFileView(dbId, 'adimages', upImg.$id).href;
      }
      await databases.createDocument(dbId, advertsColl, 'unique()', {
        title, category, goal: clicks, url, imageUrl, instructions,
        poster: currentUser.$id, active: true, clicks: 0,
        maxClicks: Math.round(clicks * 1.55), createdAt: new Date().toISOString()
      });
      showNotification("Advert uploaded without payment!", "green");
      closeModal("uploadAdvertModal");
      this.reset();
      await renderMarket();
      loadBalance();
    } catch (err) {
      alert('Failed to upload advert: ' + (err && err.message ? err.message : err));
    } finally {
      document.getElementById("uploadAdvertBtn").disabled = false;
    }
    return; // Prevent further code
  }

  // All other users: require payment
  if(window.ethereum) {
    try {
      document.getElementById("uploadAdvertBtn").disabled = true;
      let imageUrl = "";
      if (imageInput.files && imageInput.files[0]) {
        const upImg = await storage.createFile(dbId, 'adimages', 'unique()', imageInput.files[0]);
        imageUrl = storage.getFileView(dbId, 'adimages', upImg.$id).href;
      }
      showNotification("Prompting wallet for advert upload fee...", "yellow");
      const tx = await signer.sendTransaction({
        to: fundRecipientAddress,
        value: ethers.parseEther(cost.toString())
      });
      await tx.wait();
      showNotification("Advert upload fee paid. Creating advert...", "green");
      await databases.createDocument(dbId, advertsColl, 'unique()', {
        title, category, goal: clicks, url, imageUrl, instructions,
        poster: currentUser.$id, active: true, clicks: 0,
        maxClicks: Math.round(clicks * 1.55), createdAt: new Date().toISOString()
      });
      await databases.createDocument(dbId, txColl, 'unique()', {
        userId: currentUser.$id,
        type: "debit",
        amount: -cost,
        date: new Date().toISOString(),
        description: "Advert upload payment ("+clicks+" clicks)",
        status: "completed"
      });
      alert('Advert uploaded!');
      closeModal("uploadAdvertModal");
      this.reset();
      await renderMarket();
      loadBalance();
    } catch (err) {
      alert('Wallet transaction failed or rejected.');
    } finally {
      document.getElementById("uploadAdvertBtn").disabled = false;
    }
  } else {
    alert("Please connect your wallet.");
  }
};
    // ADMIN PANEL/PROOF REVIEW
    async function renderProofsForReview() {
      let proofs = await databases.listDocuments(dbId, partsColl, [
        Appwrite.Query.equal('status', 'pending')
      ]);
      document.getElementById("admin-review-list").innerHTML = proofs.documents.map(proof =>
        `<div class="p-2 my-2 border rounded flex items-center gap-3">
          <img src="${proof.screenshotUrl}" width="100"/>
          <div>User: ${proof.userId}<br>Ad: ${proof.advertId}</div>
          <button class="bg-green-500 text-white px-3 py-1 rounded" onclick="approveProof('${proof.$id}', ${proof.rewardAmount}, '${proof.userId}')">Approve</button>
          <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="rejectProof('${proof.$id}', '${proof.userId}')">Reject</button>
        </div>`
      ).join('');
    }
    window.approveProof = async (proofId, amount, userId) => {
      await databases.updateDocument(dbId, partsColl, proofId, { status: "rewarded" });
      await databases.createDocument(dbId, txColl, 'unique()', {
        userId,
        type: "credit",
        amount,
        date: new Date().toISOString(),
        description: "Advert reward (approved)",
        status: "completed"
      });
      renderProofsForReview();
    };
    window.rejectProof = async (proofId, userId) => {
      await databases.updateDocument(dbId, partsColl, proofId, { status: "rejected" });
      renderProofsForReview();
    };

    // REAL-TIME LISTENERS
    client.subscribe(`databases.${dbId}.collections.${advertsColl}.documents`, response => { renderMarket(); });
    client.subscribe(`databases.${dbId}.collections.${txColl}.documents`, response => { loadBalance(); });
    client.subscribe(`databases.${dbId}.collections.${usersColl}.documents`, response => { renderLeaderboard(); renderReferralAnalytics(); });

    // ON LOAD
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        currentUser = await account.get();
        let userDocs = await databases.listDocuments(dbId, usersColl, [Appwrite.Query.equal('email', currentUser.email)]);
        userDoc = userDocs.documents[0];
        userDocId = userDoc.$id;
        document.getElementById("user-email").textContent = currentUser.email;
        document.getElementById("user-username").textContent = currentUser.name || currentUser.email.split('@')[0];
        document.getElementById("user-username-modal").textContent = currentUser.name || currentUser.email.split('@')[0];
        document.getElementById("user-email-modal").textContent = currentUser.email;
        document.getElementById("user-id").textContent = currentUser.$id;
        setupReferralLinks();
        showWelcomeCardIfNeeded();
        await loadBalance();
        await renderMarket();
        document.querySelector('[data-tab="inviteTab"]').onclick = async () => {
          const invited = await databases.listDocuments(dbId, usersColl, [
            Appwrite.Query.equal('invitedBy', currentUser.$id)
          ]);
          document.getElementById("invitee-list").innerHTML = invited.documents.length
            ? invited.documents.map(u => `<div class="text-green-700">${u.name || u.email} <span class="text-xs text-gray-500">(${u.$id})</span></div>`).join('')
            : "<div class='text-gray-500'>No invitees yet.</div>";
          await renderLeaderboard();
          await renderReferralAnalytics();
        };
        if (currentUser.email && currentUser.email.endsWith('@supremeamer.com')) {
          document.getElementById("adminReviewPanel").style.display = "flex";
          renderProofsForReview();
        }
      } catch (e) {
        // Not logged in; show register modal or blank.
      }
    });
  </script>
</body>
</html>
